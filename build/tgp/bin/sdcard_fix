#!/sbin/sh

OUTFD=/proc/self/fd/$2;

set_perm() {
  uid=$1; gid=$2; mod=$3;
  shift 3;
  chown $uid.$gid $*; chown $uid:$gid $*;
  chmod $mod $*;
}
set_perm_recursive() {
  uid=$1; gid=$2; dmod=$3; fmod=$4;
  shift 4;
  until [ ! "$1" ]; do
    chown -R $uid.$gid $1; chown -R $uid:$gid $1;
    find "$1" -type d -exec chmod $dmod {} +;
    find "$1" -type f -exec chmod $fmod {} +;
    shift;
  done;
}

restore_con() { 
  for i in /system/bin/toybox /system/toolbox /system/bin/toolbox; do
    LD_LIBRARY_PATH=/system/lib $i restorecon -R $*;
  done;
  restorecon -R $*;
}

set_perm_recursive 1023 1023 0775 0664 "/data/media";
set_perm 1023 1023 0770 "/data/media" "/data/media/0";
restore_con /data/media/0;

if [ -d /data/media/0/TWRP ]; then
  set_perm_recursive 0 0 0777 0664 "/data/media/0/TWRP";
  set_perm_recursive 1023 1023 0777 0664 "/data/media/0/TWRP/BACKUPS";
fi;

exit 0;

